# DO5_Simple Docker. Report

## Part 1. Готовый докер

В качестве конечной цели своей небольшой практики ты сразу выбрал написание докер-образа для собственного веб-сервера, а потому в начале тебе нужно разобраться с уже готовым докер-образом для сервера.

Твой выбор пал на довольно простой nginx.

== Задание ==

- Возьми официальный докер-образ с nginx и выкачай его при помощи docker pull.

![](./part_1/01.png)

- Проверь наличие докер-образа через docker images.

![](./part_1/02.png)

- Запусти докер-образ через docker run -d [image_id|repository].

![](./part_1/03.png)

- Проверь, что образ запустился через docker ps.

![](./part_1/04.png)

- Посмотри информацию о контейнере через docker inspect [container_id|container_name].

![](./part_1/05.png)

- По выводу команды определи и помести в отчёт размер контейнера, список замапленных портов и ip контейнера.

![](./part_1/06.png)

![](./part_1/07.png)

![](./part_1/08.png)

- Останови докер контейнер через docker stop [container_id|container_name].

![](./part_1/09.png)

- Проверь, что контейнер остановился через docker ps.

![](./part_1/10.png)

- Запусти докер с портами 80 и 443 в контейнере, замапленными на такие же порты на локальной машине, через команду run.

![](./part_1/11.png)

- Проверь, что в браузере по адресу localhost:80 доступна стартовая страница nginx.

![](./part_1/12.png)

- Перезапусти докер контейнер через docker restart [container_id|container_name].

![](./part_1/13.png)

- Проверь любым способом, что контейнер запустился.

![](./part_1/14.png)

В отчёт помести скрины:

вызова и вывода всех использованных в этой части задания команд;
стартовой страницы nginx по адресу localhost:80 (адрес должен быть виден).


Замечание: Не загружай тяжелые файлы (>10 мб) в гит.

## Part 2. Операции с контейнером
Докер-образ и контейнер готовы. Теперь можно покопаться в конфигурации nginx и отобразить статус страницы.

== Задание ==

- Прочитай конфигурационный файл nginx.conf внутри докер контейнера через команду exec.

![](./part_2/01.png)

- Создай на локальной машине файл nginx.conf.

- Настрой в нем по пути /status отдачу страницы статуса сервера nginx.

![](./part_2/02.png)

- Скопируй созданный файл nginx.conf внутрь докер-образа через команду docker cp.

![](./part_2/03.png)

- Перезапусти nginx внутри докер-образа через команду exec.

![](./part_2/04.png)

- Проверь, что по адресу localhost:80/status отдается страничка со статусом сервера nginx.

![](./part_2/05.png)

- Экспортируй контейнер в файл container.tar через команду export.

- Останови контейнер.

![](./part_2/06.png)

- Удали образ через docker rmi [image_id|repository], не удаляя перед этим контейнеры.

![](./part_2/07.png)

- Удали остановленный контейнер.

![](./part_2/08.png)

- Импортируй контейнер обратно через команду import.

![](./part_2/09.png)

- Запусти импортированный контейнер.

![](./part_2/10.png)

- Проверь, что по адресу localhost:80/status отдается страничка со статусом сервера nginx.

![](./part_2/11.png)

В отчёт помести скрины:

вызова и вывода всех использованных в этой части задания команд;
содержимое созданного файла nginx.conf;
страницы со статусом сервера nginx по адресу localhost:80/status.


## Part 3. Мини веб-сервер

Теперь стоит немного оторваться от докера, чтобы подготовиться к последнему этапу. Время написать свой сервер.

== Задание ==

- Напиши мини-сервер на C и FastCgi, который будет возвращать простейшую страничку с надписью Hello World!.

Устанавливаем либу <fcgiapp.h>
 
sudo apt-get install libfcgi libfcgi-dev

gcc ./mini_server_-_spawn-fcgi.c -o mini_server_-_spawn-fcgi -lfcgi


![](./part_3/01.png)

![](./part_3/02.png)

![](./part_3/03.png)

- Запусти написанный мини-сервер через spawn-fcgi на порту 8080.

sudo apt-get install spawn-fcgi

gcc ./mini_server_+_spawn-fcgi.c -o mini_server_+_spawn-fcgi -lfcgi

spawn-fcgi -p 8080 -n ./mini_server_+_spawn-fcgi

![](./part_3/04.png)

![](./part_3/05.png)

- Напиши свой nginx.conf, который будет проксировать все запросы с 81 порта на 127.0.0.1:8080.

выше уже есть

- Проверь, что в браузере по localhost:81 отдается написанная тобой страничка.

выше уже есть два варианта: без и с spawn-fcgi

- Положи файл nginx.conf по пути ./nginx/nginx.conf (это понадобится позже).


## Part 4. Свой докер

Теперь всё готово. Можно приступать к написанию докер-образа для созданного сервера.
== Задание ==
При написании докер-образа избегай множественных вызовов команд RUN

- Напиши свой докер-образ, который:

1) собирает исходники мини сервера на FastCgi из Части 3;

2) запускает его на 8080 порту;

3) копирует внутрь образа написанный ./nginx/nginx.conf;

4) запускает nginx.
nginx можно установить внутрь докера самостоятельно, а можно воспользоваться готовым образом с nginx'ом, как базовым.

![](./part_4/01.png)

![](./part_4/02.png)

- Собери написанный докер-образ через docker build при этом указав имя и тег.

docker build -t my-nginx:latest .

- Проверь через docker images, что все собралось корректно.

![](./part_4/03.png)

- Запусти собранный докер-образ с маппингом 81 порта на 80 на локальной машине и маппингом папки ./nginx внутрь контейнера по адресу, где лежат конфигурационные файлы nginx'а (см. Часть 2).

docker run -d -p 80:81 my-nginx

- Проверь, что по localhost:80 доступна страничка написанного мини сервера.

![](./part_4/04.png)

- Допиши в ./nginx/nginx.conf проксирование странички /status, по которой надо отдавать статус сервера nginx.

Перезапусти докер-образ.
Если всё сделано верно, то, после сохранения файла и перезапуска контейнера, конфигурационный файл внутри докер-образа должен обновиться самостоятельно без лишних действий.

Проверь, что теперь по localhost:80/status отдается страничка со статусом nginx

![](./part_4/06.png)

## Part 5. Dockle

После написания образа никогда не будет лишним проверить его на безопасность.
== Задание ==

- Просканируй образ из предыдущего задания через dockle [image_id|repository].

docker save my-nginx:latest -o my.tar

dockle --input my.tar

![](./part_5/01.png)

- Исправь образ так, чтобы при проверке через dockle не было ошибок и предупреждений.

![](./part_5/02.png)

![](./part_5/03.png)


## Part 6. Базовый Docker Compose

Вот ты и закончил свою разминку. А хотя погоди...
Почему бы не поэкспериментировать с развёртыванием проекта, состоящего сразу из нескольких докер-образов?
== Задание ==

Напиши файл docker-compose.yml, с помощью которого:


- 1) Подними докер-контейнер из Части 5 (он должен работать в локальной сети, т. е. не нужно использовать инструкцию EXPOSE и мапить порты на локальную машину).

docker build -t serv5 ./part_5/

docker run -d serv5

docke inspect CONTAINER_ID ищем IP 172.17.0.2 и вписываем в nginx.conf serv6

![](./part_6/01.png)

- 2) Подними докер-контейнер с nginx, который будет проксировать все запросы с 8080 порта на 81 порт первого контейнера.

Замапь 8080 порт второго контейнера на 80 порт локальной машины.

![](./part_6/02.png)

docker build -t serv6 ./part_6/

docker run -d -p 80:8080 serv6

- Запускаем проверям:

![](./part_6/03.png)

![](./part_6/04.png)

- Останови все запущенные контейнеры.

![](./part_6/05.png)

-  Файл docker-compose.yml

![](./part_6/06.png)

-  Меням у проксирующего сервера nginx.conf 

![](./part_6/07.png)

- Собери и запусти проект с помощью команд docker-compose build и docker-compose up.

![](./part_6/08.png)

- Проверь, что в браузере по localhost:80 отдается написанная тобой страничка, как и ранее.

![](./part_6/09.png)

